From 693f6e7a52b942879850ba60b540cea277d1b5d5 Mon Sep 17 00:00:00 2001
From: wusel <wusel+src@uu.org>
Date: Sun, 25 Jun 2023 03:19:39 +0200
Subject: [PATCH] Allow setting HTMODE from site

---
 .../luasrc/lib/gluon/upgrade/200-wireless     | 32 ++++++++++++++++---
 1 file changed, 27 insertions(+), 5 deletions(-)

diff --git a/package/gluon-core/luasrc/lib/gluon/upgrade/200-wireless b/package/gluon-core/luasrc/lib/gluon/upgrade/200-wireless
index 604e33a8..8826936a 100755
--- a/package/gluon-core/luasrc/lib/gluon/upgrade/200-wireless
+++ b/package/gluon-core/luasrc/lib/gluon/upgrade/200-wireless
@@ -66,6 +66,8 @@ local function get_channel(radio, config)
 end
 
 local function get_htmode(radio)
+	local site_htmode
+	
 	if radio.band == '5g' and is_outdoor() then
 		local outdoor_htmode = uci:get('gluon', 'wireless', 'outdoor_' .. radio['.name'] .. '_htmode')
 		if outdoor_htmode ~= nil then
@@ -74,15 +76,35 @@ local function get_htmode(radio)
 	end
 
 	local phy = wireless.find_phy(radio)
-	if iwinfo.nl80211.hwmodelist(phy).ax then
-		return 'HE20'
+	if radio.band == '5g' then
+		site_htmode=site.wifi5.htmode('HT20')
+	else
+		site_htmode=site.wifi2.htmode('HT20')
 	end
-
+	
 	if iwinfo.nl80211.hwmodelist(phy).ac then
-		return 'VHT20'
+		if site_htmode == 'HT40' then
+			site_htmode = 'VHT40'
+		end
+		if site_htmode == 'HT20' then
+			site_htmode = 'VHT20'
+		end
 	end
+	
+	if iwinfo.nl80211.hwmodelist(phy).ax then
+		if site_htmode == 'HT40' then
+			site_htmode = 'HE40'
+		end
+		if site_htmode == 'HT20' then
+			site_htmode = 'HE20'
+		end
+	end
+
+	uci:set('gluon', 'wireless', radio['.name'] .. '_htmode', site_htmode)
+	uci:save('gluon')
+	uci:commit('gluon')
 
-	return 'HT20'
+	return site_htmode
 end
 
 local function is_disabled(name)
-- 
2.30.2

